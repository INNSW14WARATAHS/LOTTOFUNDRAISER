<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>INNSW 14 WARATAHS - LOTTO BOARD FUNDRAISER</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{color-scheme:dark light}
    body{margin:0;font-family:Poppins,system-ui,Arial,sans-serif;background:linear-gradient(135deg,#0b355b,#103b6e);color:#fff;min-height:100vh;}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:#0a2e56}
    header img{height:80px}
    h1{margin:0;font-size:1.6rem}
    h2{margin:6px 0 0;opacity:.85;font-weight:400}
    main{max-width:1000px;margin:20px auto;padding:0 14px}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(60px,1fr));gap:10px;margin:18px auto;max-width:900px}
    .cell{width:60px;height:60px;border-radius:50%;background:#1d4ed8;display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;user-select:none;transition:.15s}
    .cell:hover{transform:scale(1.05);background:#2563eb}
    .cell.unavailable{background:#6b7280;color:#cbd5e1;cursor:not-allowed}
    .cell.selected{outline:3px solid #10b981}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin:10px 0}
    input,button{font-family:inherit}
    input{padding:10px 12px;border-radius:10px;border:1px solid #2b5b92;background:#0f2d54;color:#fff;min-width:220px;text-align:center}
    button{padding:10px 16px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn{background:#3b82f6;color:#fff}
    .btn.secondary{background:#1f3d66}
    .note{opacity:.9;text-align:center}

    /* Info box with text + image side-by-side (GRID) */
    .note-box{
      background:#0a2e56;
      border:1px solid #123b6a;
      border-radius:12px;
      padding:16px;
      margin:10px auto 16px;
      max-width:900px;
      width:100%;
      opacity:.95;
    }
    .note-flex{
      display:grid;
      grid-template-columns: 1fr 0.95fr; /* text | image */
      gap:18px;
      align-items:stretch;  /* children stretch to the grid row height (set by tallest content) */
    }
    .note-copy{
      text-align:left;
      line-height:1.55;
    }
    .note-copy p{margin:0}
    .note-media{
      display:grid;      /* lets the img stretch cleanly with height:100% */
      overflow:hidden;   /* hides any tiny overflow from rounding */
      border-radius:10px;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.08);
    }
    .note-media img{
      width:100%;
       height:100%;       /* üëà fixed height */
      object-fit:cover;  /* fill column, crop evenly instead of stretching */
      display:block;
    }

    /* Stack on small screens */
    @media (max-width:720px){
      .note-flex{
        grid-template-columns: 1fr;
      }
      .note-copy{text-align:center}
      .note-media{
        border-radius:10px;
      }
      .note-media img{
        height:auto;      /* natural height when stacked */
        width:100%;
        object-fit:contain;
      }
    }

    /* Loading/progress style for buttons */
    .btn.loading{position:relative;opacity:.7;cursor:wait}
    .btn.loading::after{
      content:"";position:absolute;left:6px;right:6px;bottom:-6px;height:4px;
      background:rgba(255,255,255,.25);border-radius:999px;overflow:hidden;
    }
    .btn.loading::before{
      content:"";position:absolute;left:6px;bottom:-6px;height:4px;width:30%;
      background:#10b981;border-radius:999px;animation:loadbar 1.2s infinite ease-in-out;
    }
    @keyframes loadbar{0%{left:6px;width:20%}50%{left:50%;width:40%}100%{left:calc(100% - 30% - 6px);width:30%}}

    /* Stripe area */
    #stripeWrap{display:flex;justify-content:center;margin-top:10px}
    #stripeBox{background:#0a2e56;border:1px solid #123b6a;border-radius:12px;padding:16px;min-width:320px;max-width:520px;width:100%}
    #stripeActions{display:flex;gap:10px;justify-content:center;margin-top:12px}
    #payment-status{margin-top:8px;text-align:center;min-height:20px;opacity:.9}

    /* Timer */
    #hold-timer{display:none;margin-top:8px;text-align:center;font-weight:600;color:#10b981;font-size:1rem;}
  </style>

  <script src="https://js.stripe.com/v3"></script>
</head>
<body>
<header>
  <img src="mascot.png" alt="Mascot">
  <div>
    <h1>INNSW 14 WARATAHS - LOTTO BOARD FUNDRAISER</h1>
    <h2>$10 per number ¬∑ pick one or more (1‚Äì400)</h2>
  </div>
  <img src="isnsw-redo.png" alt="Logo">
</header>

<main>

  <!-- üîπ Information area ABOVE form, with right-side static image -->
  <div id="raffle-note" class="note-box">
    <div class="note-flex">
      <div class="note-copy">
        <p>
          <b>Help the INNSW 14 Waratahs get to Nationals!</b><br><br>
          Our amazing team is raising funds to get to Ipswich for the 2025 Nationals. Each player self-funds their trip ‚Äî covering flights, uniforms, levies, transport, food, and accommodation (over $1800 each!).<br><br>
          <b>Support us by entering our Lucky Lotto Board Raffle!</b><br>
          ‚Äì $10 per number ‚Äî buy as many as you like<br>
          ‚Äì Great prizes including Mecca, Event Cinemas & City Cave vouchers, hampers, and 1st prize $500 cash!<br>
          ‚Äì Drawn online before Christmas<br><br>
          Every ticket helps our team get to Nationals ‚Äî thank you for your support!
        </p>
      </div>
      <div class="note-media">
        <img
          src="https://raw.githubusercontent.com/INNSW14WARATAHS/LOTTOFUNDRAISER/refs/heads/main/image_1.png"
          alt="INNSW Waratahs fundraiser image">
      </div>
    </div>
  </div>

  <div class="row">
    <input id="name"  placeholder="Your name"  required>
    <input id="email" placeholder="Email (receipt)" required type="email">
    <input id="phone" placeholder="Phone (optional)">
  </div>

  <div class="row">
    <button id="clearBtn" class="btn secondary">Clear Selection</button>
    <button id="lockBtn" class="btn">Click To Lock In Numbers</button>
  </div>

  <!-- Locking warning -->
<div id="lock-warning" style="
  display:none; margin:10px auto; max-width:900px; text-align:center;
  font-weight:700; background:#4b1d1d; border:1px solid #b91c1c; color:#fecaca;
  padding:12px 14px; border-radius:10px;">
  ‚ö†Ô∏è <span style="color:#fff">DO NOT REFRESH YOUR BROWSER</span><br>
  Locking numbers may take up to 60 seconds ‚Äî once numbers are successfully locked, please wait for the
  payment box to appear to complete your checkout.
</div>

  <!-- üîπ Countdown timer -->
  <div id="hold-timer"></div>

  <div id="stripeWrap">
    <div id="stripeBox" style="display:none">
      <div id="payment-element"></div>
      <div id="stripeActions">
        <button id="payBtn" class="btn">Pay Now</button>
      </div>
      <div id="payment-status"></div>
    </div>
  </div>
<!-- Persistent success message (stays until refresh) -->
<div id="order-success" style="display:none;margin:12px auto 6px;max-width:900px;text-align:center;
  font-weight:600;background:#063b2a;border:1px solid #0e7a58;color:#10b981;padding:10px 14px;border-radius:10px;">
</div>
  <p id="summary" class="note"></p>
  <div id="board" class="grid">Loading numbers‚Ä¶</div>
</main>

<script>
  const APP = "https://script.google.com/macros/s/AKfycbwpBLBVntmLUsIF1LCrEh8Zsf0n1FcQfLxxjyXGjQbjMCqBDUQ3om4Irq2hK8gy6S_G/exec";

  // Send JSON without triggering CORS preflight (Apps Script-friendly)
async function postPlain(url, data) {
  return fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify(data)
  });
}


  const board=document.getElementById('board');
  const lockBtn=document.getElementById('lockBtn');
  const clearBtn=document.getElementById('clearBtn');
  const summary=document.getElementById('summary');
  const timerDiv=document.getElementById('hold-timer');

  const stripeBox=document.getElementById('stripeBox');
  const paymentElementDiv=document.getElementById('payment-element');
  const payBtn=document.getElementById('payBtn');
  const paymentStatus=document.getElementById('payment-status');
  const orderSuccess = document.getElementById('order-success');
  const lockWarning = document.getElementById('lock-warning');


  let STATE=null;
  let selected=new Set();
  let holdId=null;

  let stripe=null;
  let elements=null;
  let clientSecret=null;

  /* ===== TIMER ===== */
  let holdTimer, holdSeconds=0;
  function startHoldCountdown(minutes){
    holdSeconds=minutes*60;
    timerDiv.style.display='block';
    clearInterval(holdTimer);
    holdTimer=setInterval(()=>{
      const m=Math.floor(holdSeconds/60);
      const s=holdSeconds%60;
      timerDiv.textContent=`Numbers held for ${m}:${s.toString().padStart(2,'0')}`;
      if(holdSeconds--<=0){
        clearInterval(holdTimer);
        timerDiv.textContent='Reservation expired ‚Äî please try again.';
      }
    },1000);
  }

  function money(cents){
    return new Intl.NumberFormat(undefined,{style:'currency',currency:(STATE?.currency||'AUD')}).format(cents/100);
  }

  function updateSummary(){
    const arr=[...selected].sort((a,b)=>a-b);
    if(!arr.length){summary.textContent='No numbers selected yet.';return;}
    const total=(STATE?.price_cents||1000)*arr.length;
    summary.textContent=`Selected: ${arr.join(', ')} ¬∑ Qty ${arr.length} ¬∑ Total ${money(total)}`;
  }

  async function loadState(){
    const r=await fetch(APP+'?path=state');
    STATE=await r.json();
    renderGrid(STATE.numbers||[]);
  }

  function renderGrid(nums){
    board.innerHTML='';
    nums.forEach(n=>{
      const d=document.createElement('div');
      d.className='cell'+(n.status==='available'?'':' unavailable');
      d.textContent=n.num;
      if(n.status==='available'){
        d.onclick=()=>{if(holdId)return;
          if(selected.has(n.num))selected.delete(n.num);else selected.add(n.num);
          d.classList.toggle('selected');updateSummary();
        };
      }
      board.appendChild(d);
    });
    updateSummary();
  }

clearBtn.onclick = async () => {
  selected.clear();
  holdId = null;
  teardownStripe();

  timerDiv.style.display = 'none';
  clearInterval(holdTimer);

  // hide any messages/banners
  orderSuccess.style.display = 'none';
  lockWarning.style.display = 'none';
  paymentStatus.textContent = '';

  await loadState();
  window.scrollTo({ top: 0, behavior: 'smooth' });
};




  async function withLoading(btn,task){
    btn.disabled=true;btn.classList.add('loading');
    const oldText=btn.textContent;
    btn.textContent=(btn===lockBtn?'Locking...':'Processing...');
    try{return await task();}
    finally{btn.disabled=false;btn.classList.remove('loading');btn.textContent=oldText;}
  }

  function teardownStripe(){
    paymentStatus.textContent='';paymentElementDiv.innerHTML='';
    stripeBox.style.display='none';stripe=null;elements=null;clientSecret=null;
  }

  async function renderStripeElements(){
    try{
      const r=await fetch(APP+'?path=stripe_intent',{method:'POST',body:JSON.stringify({hold_id:holdId})});
      const jr=await r.json();

if(!jr.ok){
  stripeBox.style.display='block';
  paymentStatus.textContent=jr.error||'Could not start payment.';
  lockWarning.style.display='none';
  return;
}



      clientSecret=jr.client_secret;
      const pk=jr.publishable_key;
      if(!pk||!clientSecret){stripeBox.style.display='block';paymentStatus.textContent='Stripe keys not configured.';return;}

      stripe=Stripe(pk);
      elements=stripe.elements({clientSecret,appearance:{theme:'night'}});
      const paymentElement=elements.create('payment',{layout:'tabs'});
      paymentElement.mount('#payment-element');

stripeBox.style.display='block';
lockWarning.style.display='none';   // hide red warning when Stripe is visible
payBtn.textContent=(jr.amount_cents&&jr.currency)?`Pay ${money(jr.amount_cents)} Now`:'Pay Now';
paymentStatus.textContent='';


} catch(err){
  console.error(err);
  stripeBox.style.display='block';
  paymentStatus.textContent='Network error starting payment.';
  lockWarning.style.display='none';
}
  }

  async function confirmStripePayment(){
    if(!stripe||!elements){paymentStatus.textContent='Payment form not ready yet.';return;}
    paymentStatus.textContent='Confirming payment‚Ä¶';
    const {error,paymentIntent}=await stripe.confirmPayment({
      elements,
      confirmParams:{return_url:window.location.href},
      redirect:'if_required'
    });

    if(error){console.error(error);paymentStatus.textContent=error.message||'Payment failed.';return;}

    if(paymentIntent&&paymentIntent.status==='succeeded'){
      try{
        const fin = await postPlain(APP + '?path=stripe_finalize', {
  hold_id: holdId,
  payment_intent_id: paymentIntent.id
});
if (!fin.ok) { paymentStatus.textContent = `Finalize request failed (${fin.status})`; return; }

const fj = await fin.json();
if (!fj.ok) { paymentStatus.textContent = fj.error || 'Finalization failed.'; return; }

        // Persistent message under the Stripe box (stays until refresh)
orderSuccess.textContent = '‚úÖ Payment successful ‚Äî your numbers are confirmed.';
orderSuccess.style.display = 'block';
        holdId=null;selected.clear();teardownStripe();
        timerDiv.style.display='none';clearInterval(holdTimer);
        await loadState();window.scrollTo({top:0,behavior:'smooth'});
      }catch(e){console.error(e);paymentStatus.textContent='Paid but could not finalize.';}
      return;
    }
    paymentStatus.textContent='Please complete any additional authentication steps.';
  }

 document.getElementById('lockBtn').onclick = () =>
  withLoading(lockBtn, async () => {
    // If already holding, just jump to payment box
    if (holdId) { stripeBox?.scrollIntoView({ behavior: 'smooth' }); return; }

    // show the red warning while we lock & prepare Stripe
    lockWarning.style.display = 'block';
    lockWarning.style.borderColor = '#b91c1c';
    lockWarning.style.background = '#4b1d1d';
    lockWarning.style.color = '#fecaca';
    lockWarning.innerHTML = '‚ö†Ô∏è <span style="color:#fff">DO NOT REFRESH YOUR BROWSER</span><br>Locking numbers may take up to 60 seconds ‚Äî once numbers are successfully locked, please wait for the payment box to appear to complete your checkout.';

    try {
      const name  = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const numbers = [...selected];

      if (!numbers.length)  throw new Error('Please select at least one number.');
      if (!name || !email)  throw new Error('Please enter your name and email.');

  const res = await postPlain(APP + '?path=reserve', { name, email, phone, numbers });
if (!res.ok) throw new Error(`Reserve request failed (${res.status})`);
const jr = await res.json();
      if (!jr.ok) throw new Error(jr.error || 'Could not lock your numbers. Try again.');

      // Locked successfully
      holdId = jr.hold_id;
      startHoldCountdown(10);
      await loadState();

      // Build Stripe UI; hide the warning when it appears
      await renderStripeElements();
      stripeBox?.scrollIntoView({ behavior: 'smooth' });
    } catch (err) {
      // Show the reason in the red box
      lockWarning.style.display = 'block';
      lockWarning.innerHTML = `‚ùå <span style="color:#fff">Could not lock your numbers.</span><br>${(err && err.message) || err}`;
    }
  });



  payBtn.onclick=()=>withLoading(payBtn,confirmStripePayment);

  loadState();
</script>
</body>
</html>
