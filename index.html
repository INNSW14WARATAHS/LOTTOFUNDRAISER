<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INNSW Lotto Raffle</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; background: #fff; margin: 0; padding: 0; text-align:center; }
    .container { max-width: 600px; margin: 40px auto; padding: 20px; }
    h1 { color: #c81e24; }
    .numbers { display: flex; flex-wrap: wrap; justify-content: center; margin: 10px 0; }
    .num { width: 50px; height: 50px; margin: 4px; line-height: 50px; border-radius: 8px;
           background: #f2f2f2; border: 1px solid #ddd; cursor: pointer; font-weight: 500; }
    .num.held, .num.paid { background: #ccc; cursor: not-allowed; color: #666; }
    .num.selected { background: #c81e24; color: #fff; }
    #lock-btn { margin-top: 15px; padding: 12px 24px; background:#c81e24; color:#fff;
                border:none; border-radius:8px; cursor:pointer; font-size:16px; font-weight:600; }
    #lock-btn.loading { opacity:0.7; pointer-events:none; position:relative; }
    #lock-btn.loading::after {
      content:""; position:absolute; top:50%; left:50%; width:18px; height:18px;
      margin:-9px 0 0 -9px; border:2px solid #fff; border-top-color:transparent;
      border-radius:50%; animation:spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    #status { margin-top:15px; font-weight:500; }
    #hold-timer { display:none; margin-top:10px; font-weight:600; color:#c81e24; }
  </style>
</head>
<body>
  <div class="container">
    <h1>INNSW Lotto Raffle</h1>
    <p>Select your numbers below:</p>

    <div id="numbers" class="numbers"></div>

    <button id="lock-btn" onclick="lockNumbers()">Lock in Numbers</button>
    <div id="status"></div>
    <div id="hold-timer"></div>

    <!-- Stripe placeholder (unchanged visual) -->
    <div id="stripe-container" style="margin-top:20px; display:none;">
      <p>Redirecting to secure payment...</p>
    </div>
  </div>

  <script>
  const API_BASE = 'https://script.google.com/macros/s/YOUR_SCRIPT_DEPLOYMENT_ID/exec';
  let selected = [];
  let holdTimer, holdSeconds = 0;

  function loadNumbers(){
    fetch(API_BASE + '?path=state').then(r=>r.json()).then(d=>{
      const area=document.getElementById('numbers');
      area.innerHTML='';
      d.numbers.forEach(n=>{
        const div=document.createElement('div');
        div.textContent=n.num;
        div.className='num '+(n.status!=='available'?n.status:'');
        if(n.status==='available') div.onclick=()=>toggleSelect(div,n.num);
        area.appendChild(div);
      });
    });
  }

  function toggleSelect(el,num){
    if(el.classList.contains('selected')){
      el.classList.remove('selected');
      selected=selected.filter(n=>n!==num);
    }else{
      el.classList.add('selected');
      selected.push(num);
    }
  }

  async function lockNumbers(){
    if(selected.length===0) return alert('Please select at least one number.');
    const btn=document.getElementById('lock-btn');
    const status=document.getElementById('status');
    btn.classList.add('loading');
    status.textContent='Locking your numbers...';

    try{
      const body={ name:'Customer', email:'test@example.com', numbers:selected };
      const res=await fetch(API_BASE+'?path=reserve',{method:'post',body:JSON.stringify(body)});
      const data=await res.json();
      if(!data.ok){ status.textContent=data.error; btn.classList.remove('loading'); return; }

      status.textContent='Numbers locked! Proceeding to payment...';
      startHoldCountdown(2); // 2-minute visual timer
      createStripeIntent(data.hold_id);

    }catch(err){
      status.textContent='Error: '+err.message;
    }finally{
      btn.classList.remove('loading');
    }
  }

  function startHoldCountdown(minutes){
    holdSeconds = minutes * 60;
    const el = document.getElementById('hold-timer');
    el.style.display = 'block';
    clearInterval(holdTimer);
    holdTimer = setInterval(() => {
      const m = Math.floor(holdSeconds / 60);
      const s = holdSeconds % 60;
      el.textContent = `Your numbers are reserved for ${m}:${s.toString().padStart(2,'0')}`;
      if (holdSeconds-- <= 0) {
        clearInterval(holdTimer);
        el.textContent = 'Reservation expired â€” please try again.';
      }
    }, 1000);
  }

  async function createStripeIntent(hold_id){
    const stripeDiv=document.getElementById('stripe-container');
    stripeDiv.style.display='block';
    try{
      const res=await fetch(API_BASE+'?path=stripe_intent',{method:'post',body:JSON.stringify({hold_id})});
      const data=await res.json();
      if(!data.ok) return alert(data.error);

      // Redirect to Stripe
      const stripe=Stripe(data.publishable_key);
      const {error}=await stripe.redirectToCheckout({clientReferenceId:hold_id, sessionId:data.client_secret});
      if(error) alert(error.message);
    }catch(err){
      alert('Stripe error: '+err.message);
    }
  }

  loadNumbers();
  </script>
  <script src="https://js.stripe.com/v3/"></script>
</body>
</html>
